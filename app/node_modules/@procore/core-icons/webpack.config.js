const path = require('path')
const webpack = require('webpack')
const GenerateJsonPlugin = require('generate-json-webpack-plugin')
const {
  addPlugins,
  createConfig,
  sass,
  devServer,
  entryPoint,
  env,
  extractText,
  file,
  match,
  setOutput,
  url,
} = require('webpack-blocks')

const package = require('./package.json')

const selection = require('./src/selection.json')

module.exports = createConfig([
  entryPoint('./src/main.scss'),

  setOutput({
    path: path.resolve(__dirname, 'build'),
    filename: 'icons.js',
    publicPath: '',
  }),

  match('*.scss', {}, [
    extractText('icons.css'),
    sass({ localIdentName: '[local]', minimize: true }),
  ]),

  match(['*.eot', '*.svg', '*.ttf', '*.woff', '*.woff2'], [file()]),

  addPlugins([
    new GenerateJsonPlugin(
      'icons.json',
      selection.icons.map(icon => icon.properties.name).sort()
    ),
  ]),

  env('production', [
    addPlugins([
      new webpack.BannerPlugin({
        banner: `${package.name} v${
          package.version
        } (https://procore.github.io/core/latest/icons)\nCopyright (c) 2018 Procore Technologies, Inc.`,
      }),
    ]),
  ]),
])
